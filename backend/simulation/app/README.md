# Fleet Simulation Service

This simulation service creates virtual cars and moves them along predefined routes for fleet management testing and telemetry. Each car sends timeseries data to a backend and checks for geofence events as it moves.

---

## What Does It Do?

- **Reads routes** from a `processed_routes.json` file (generated by Google service generation program).
- **Creates simulated cars** with random but realistic attributes.
- **Moves each car** back and forth along its assigned route, step by step.
- **Sends telemetry data** (location, speed, fuel, etc.) to a backend microservice at each step.
- **Checks geofence status** every 10 steps via a backend API (in the app folder).

---

## API Calls

| Method | Endpoint                       | Description                       |
|--------|-------------------------------|-----------------------------------|
| POST   | `/simulation/start/{num_cars}` | Start with N cars                 |
| POST   | `/simulation/pause`            | Pause simulation                  |
| POST   | `/simulation/resume`           | Resume paused simulation          |
| POST   | `/simulation/stop`             | Stop and cleanup                  |
| POST   | `/sessions`                    | Add sessions to car ranges        |
| GET    | `/status`                      | Get simulation status             |
| DELETE | `/cars/{id}/sessions`          | Clear car sessions                |

---

## Prerequisites

- **Docker** and **Docker Compose** installed on your system.
- The following microservices must be running and accessible:
    - **Static Service** (for initial car creation, only needed once)
    - **TimeSeries POST Service** (for telemetry data)
    - **Geofence GET Service** (for geofence checks)

---

## Setup Instructions

### 1. Create the `.env` File

Before running the simulation, create a `.env` file in the `backend/simulation/app/` directory with the following variables (replace the placeholders with your actual endpoints if needed):

```env
STATIC_SERVICE_ENDPOINT=http://localhost
TIMESERIES_POST_ENDPOINT=http://localhost
GEOFENCES_SERVICE_ENDPOINT=http://localhost
```

- `STATIC_SERVICE_ENDPOINT` is only required when running the static car creation script (`static_cars_creator.py`) for the first time.
- `TIMESERIES_POST_ENDPOINT` and `GEOFENCES_SERVICE_ENDPOINT` are required for the simulation to send data.

---

### 2. Build and Run with Docker Compose

This project includes a `docker-compose.yml` file in the simulation directory. To build and start all services, run:

```bash
docker-compose up --build
```

This will start the simulation microservice and any other services defined in your `docker-compose.yml`.

---

### 3. Populate the Database with Static Car Data (Run Once)

Before running the simulation for the first time, you must populate the database with static car data. This is done using the `static_cars_creator.py` script, which communicates with the Static Service.

**Steps:**

1. Ensure the Static Service is running and accessible at the endpoint specified in your `.env`.
2. Run the static car creation script (from within the container or your local environment):

     ```bash
     python static_cars_creator.py
     ```

     > **Note:** This script should only be run once to avoid duplicate car entries. After running, you can stop the Static Service if you do not need to update static car data.

---

### 4. Start the Simulation

Once the static car data is loaded and all required services are running, you can start the simulation using the API endpoints provided by the simulation microservice (see `/docs` for the FastAPI UI).

---

## Notes

- Do **not** run `static_cars_creator.py` more than once unless you intend to reset or overwrite the static car data.
- The simulation microservice depends on the TimeSeries POST and Geofence GET services for full functionality.
- The `.env` file is required for service discovery and should **not** be committed to version control with real endpoint values.

---

## How the website uses this service:
- Start car with number of cars (default 300, they are paused)
- Once user logins, starts moving and adds session to cars. If session was paused, history is created for past (1 hour, or from closest timestamp to now if less than 1 hour)
- Once user stops interacting run pause, if not in use after 15 minutes paused, runs stop. Deletes all cars, and awaits new user.

## Troubleshooting

- Ensure all dependent services are running and accessible at the endpoints specified in your `.env`.
- If you encounter connection errors, check your `.env` values and Docker Compose network settings.
- For static car creation, make sure the Static Service is running before executing `static_cars_creator.py`.

